{% extends "app_base.html" %} {% load staticfiles %} {% block title %} | Buy Package {% endblock %} {% block content %}

<section class="page-header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="page-header-content">
                    <h1>Shopping Cart</h1>
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item">
                            <a href="/">Home</a>
                        </li>
                        <li class="list-inline-item">/</li>
                        <li class="list-inline-item">
                            Shopping Cart
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<main class="site-main woocommerce single single-product page-wrapper">
    <!--shop category start-->
    <section class="space-3">
        <div class="container sm-center">
            <div class="row">
                <div class="col-lg-8">
                    <article id="post-6" class="post-6 page type-page status-publish hentry">
                        <!-- .entry-header -->
                        <div class="entry-content">
                            <div class="woocommerce">
                                <div class="woocommerce-notices-wrapper"></div>
                                <form class="woocommerce-cart-form" action="" method="">
                                    <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents" id="itemsList" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th class="product-thumbnail">&nbsp;</th>
                                                <th class="product-name">Course</th>
                                                <th class="product-quantity">Quantity</th>
                                            </tr>
                                        </thead>
                                        <tbody>


                                            <tr>
                                                <td colspan="6" class="actions">

                                                    <div class="back-to-shop mt-3">
                                                        <a class="font-weight-bold" href="{% url 'packages' %}">
                                                            <i class="fa fa-box-open"></i> Browse More Packages
                                                        </a>
                                                    </div>

                                                </td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                        <!-- .entry-content -->
                    </article>
                </div>
                <div class="col-lg-4">
                    <div class="cart-collaterals">
                        <div class="cart_totals ">
                            <h2>Cart totals</h2>
                            <table cellspacing="0" class="shop_table shop_table_responsive">
                                <tbody>
                                    <tr class="cart-subtotal">
                                        <th>Subtotal</th>
                                        <td data-title="Subtotal">
                                            <span class="woocommerce-Price-amount amount total-price">
                                            </span>
                                        </td>
                                    </tr>
                                    <tr class="order-total">
                                        <th>Total</th>
                                        <td data-title="Total"><strong>
                                                <span class="woocommerce-Price-amount amount total-price">
                                                </span></strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="wc-proceed-to-checkout">
                                {%if request.user.is_authenticated%}
                                <div id="paypal-button-container" class="mt-3">
                                </div>
                                {%else%}

                                <a href="javascript:;" class="checkout-button button alt wc-forward link-auth">
                                    Pay Now
                                </a> {%endif%}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--shop category end-->
</main>


{% endblock %} {% block scripts %} {% verbatim %}

<script type="text/x-handlebars-template" id='cartItemTemplate'>

    <tr class="woocommerce-cart-form__cart-item cart_item">

        <td class="product-thumbnail">
            <a href="#"><img width="100" height="100" src="/static/edutim/images/course.png" class="attachment-woocommerce_thumbnail size-woocommerce_thumbnail" alt=""></a>
        </td>

        <td class="product-name" data-title="Product">
            <a href="#">{{course.title}}</a>
        </td>



        <td class="product-quantity" data-title="Quantity">
            <div class="quantity">
                1
            </div>
        </td>


    </tr>


</script>
{% endverbatim %}

<script src="https://www.paypal.com/sdk/js?client-id=AfCYO-690TOTak5bLJ9lxaw-a7nY-8SBFID1X7a6Cmoyw2X4j79OMSm7ZDp_6oj218W5YKF19qqgWW0Y&currency=USD&disable-funding=credit,card">
</script>

<script>
    (function($) {

        $.PackageCartManager = function(options) {

            var that = this;
            var packagesList = [];

            var totalPrice = 0;

            var items = [];
            var payments = [];

            var settings = $.extend({}, options);

            var getList = function() {

                ShowLoadingModal("Please wait", "loading");

                var id = '{{id}}';

                var parms = {
                    format: 'json',
                    id: id
                };

                $.get('/api/packages/', parms, function(response) {
                    packagesList = response;
                    drawList();
                });
            };

            var drawList = function() {

                if (packagesList.length <= 0) {
                    window.location.href = '/';
                }

                $(".total-price").html('$' + packagesList[0].price);

                totalPrice = packagesList[0].price;

                $(packagesList[0].courses).each(function(ix, item) {

                    var source = document.getElementById("cartItemTemplate").innerHTML;
                    var template = Handlebars.compile(source);

                    $("#itemsList tbody").prepend(template(item));

                    var item = {
                        course: item.course.id,
                        price: item.course.price ? item.course.price : 0,
                        sub_total: item.course.price ? item.course.price : 0,
                        qty: 1,
                    };

                    items.push(item);

                });

                setPaypal();

                Swal.close();

            };

            var setPaypal = function() {

                paypal.Buttons({
                    funding: {
                        disallowed: [paypal.FUNDING.CREDIT]
                    },
                    style: {
                        label: 'checkout',
                    },
                    createOrder: function(data, actions) {

                        if (totalPrice <= 0) return false;

                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: totalPrice
                                },
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        // This function captures the funds from the transaction.
                        return actions.order.capture().then(function(details) {
                            if (data.orderID) {

                                var payment = {
                                    orderID: data.orderID,
                                    details: details,
                                    data: data
                                };

                                postOrder(payment);
                            }
                        });
                    }
                }).render('#paypal-button-container');


            };

            var postOrder = function(paymentData) {

                var payments = [];

                payments.push({
                    gateway: 'paypal',
                    info: JSON.stringify(paymentData),
                    total_price: totalPrice,
                    amount_paid: totalPrice,
                });

                var orderObject = {
                    ref_id: paymentData.orderID,
                    user: '{{request.user.id}}',
                    total_amount: totalPrice,
                    items: items,
                    payments: payments
                };

                $.ajax({
                    type: "POST",
                    url: "/api/orders/",
                    data: JSON.stringify(orderObject),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function(response) {

                        if (response && response.ref_id) {
                            window.location.href = '/order/' + response.ref_id + '/';
                        } else {
                            swal({
                                    title: "Order failed to complete",
                                    text: "Please refresh the page and try again.",
                                    icon: "warning",
                                    buttons: {

                                        catch: {
                                            text: "Ok",
                                            value: "catch",
                                        },

                                    },
                                })
                                .then((value) => {
                                    window.location.reload()
                                });
                        }
                    },
                    failure: function(errMsg) {}
                });
            };

            var registerEvent = function() {

                $("div").on("click", '.link-auth', function(e) {
                    e.stopPropagation();

                    Swal.fire({
                        title: 'Please login to buy this course package!',
                        showDenyButton: true,
                        showCancelButton: false,
                        confirmButtonText: 'Already have an account? Login',
                        denyButtonText: `Create a new account`,
                    }).then((result) => {
                        /* Read more about isConfirmed, isDenied below */
                        if (result.isConfirmed) {
                            window.location.href = '{% url "login" %}';
                        } else if (result.isDenied) {
                            window.location.href = '{% url "student_registration" %}';
                        }
                    });


                });
            };

            var init = function() {
                registerEvent();
                getList();
            };

            init();

            return this;

        };


    }(jQuery));

    $(document).ready(function() {
        var cartManager = new $.PackageCartManager({});
    });
</script>
{% endblock %}