{% extends "app_base.html" %}
{% load staticfiles %}

{% block title %} Cart | pdhsafety.com {% endblock %}

{% block head%}

<link rel="canonical" href="https://pdhsafety.com{{ request.path }}" />

<!-- Begin Inspectlet Asynchronous Code -->
<!-- End Inspectlet Asynchronous Code -->

{% endblock %}

{% block content %}

<section class="page-header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="page-header-content">
                    <h1>My Cart</h1>
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item">
                            <a href="/">Home</a>
                        </li>
                        <li class="list-inline-item">/</li>
                        <li class="list-inline-item">Cart</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<main class="site-main woocommerce single single-product page-wrapper">
    <!--shop category start-->
    <section class="space-3">
        <div class="container sm-center">
            <div class="row">
                <div class="col-lg-8">
                    <article id="post-6" class="post-6 page type-page status-publish hentry">
                        <!-- .entry-header -->
                        <div class="entry-content">
                            <div class="woocommerce">
                                <div class="woocommerce-notices-wrapper"></div>
                                <form class="woocommerce-cart-form" action="" method="">
                                    <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents"
                                        id="itemsList" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th class="product-remove">&nbsp;</th>
                                                <th class="product-thumbnail">&nbsp;</th>
                                                <th class="product-name">Product</th>
                                                <th class="product-price">Price</th>
                                                <th class="product-quantity">Quantity</th>
                                                <th class="product-subtotal">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                        <!-- .entry-content -->
                    </article>
                </div>
                <div class="col-lg-4">
                    <div class="cart-collaterals">
                        <div class="cart_totals">
                            <h2>Cart totals</h2>
                            <table cellspacing="0" class="shop_table shop_table_responsive">
                                <tbody>
                                    <tr class="cart-subtotal">
                                        <th>Subtotal</th>
                                        <td data-title="Subtotal">
                                            <span class="woocommerce-Price-amount amount">
                                                <span class="woocommerce-Price-currencySymbol">$</span>
                                                <span class="sub-total-price"></span>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr class="order-total">
                                        <th>Total</th>
                                        <td data-title="Total">
                                            <strong>
                                                <span class="woocommerce-Price-amount amount">
                                                    <span class="woocommerce-Price-currencySymbol">$</span>
                                                    <span class="total-price"></span>
                                                </span>
                                            </strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="wc-proceed-to-checkout d-none">

                                <a href="{% url 'checkout_detail' %}"
                                class="checkout-button button alt wc-forward">Proceed to checkout</a>

                                {% comment %} {% if request.user.is_authenticated %}
                               
                                {% else %}
                                <a class="checkout-button button alt wc-forward link-auth">Proceed to checkout</a>
                                {% endif %} {% endcomment %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--shop category end-->

    <section class="team section-padding bg-grey py-3 my-4">
        <div class="container">
            <div class="row">
                <div class="col text-center">
                    <img src="{% static 'images/money_back.png' %}" width="400" alt="money back" />
                </div>
            </div>
        </div>
    </section>
</main>

{% verbatim %}
<script type="text/x-handlebars-template" id="cartItemTemplate">
   <tr class="woocommerce-cart-form__cart-item cart_item" data-id="{{pk}}">
      <td class="product-remove">
         <a
            href="javascript:;"
            class="remove link-remove-item btn btn-warning btn-sm"
            data-id="{{pk}}"
            aria-label="Remove this item"
            data-product_id="30"
            data-product_sku=""
         >Ã—</a>
      </td>
      <td class="product-thumbnail">
         <a href="#">
            <img width="324" height="324" src="{{fields.image}}" class="attachment-woocommerce_thumbnail size-woocommerce_thumbnail" alt="" /></a>
      </td>

      <td class="product-name" data-title="Product">
         <a href="{{course_link}}">{{fields.title}}</a>
      </td>

      <td class="product-price" data-title="Price">
         <span class="woocommerce-Price-amount amount">
            <span class="woocommerce-Price-currencySymbol">$</span>
            {{final_price}}</span>
      </td>

      <td class="product-quantity" data-title="Quantity">
         <div class="quantity">
            <label class="screen-reader-text" for="quantity_5cc58182489a8">Quantity</label>
            <input
               type="number"
               class="input-text qty text text-center"
               step="1"
               min="1"
               max=""
               readonly
               value="1"
               title="Qty"
               size="4"
               pattern="[0-9]*"
               inputmode="numeric"
               style="width:90px;"
            /></div>
      </td>
      <td class="product-subtotal" data-title="Total">
         <span class="woocommerce-Price-amount amount">
            <span class="woocommerce-Price-currencySymbol">$</span>
            {{final_price}}</span>
      </td>
   </tr>
</script>
{% endverbatim %}

{% endblock %}

{% block scripts %}

<style>
    @media (max-width: 768px) {
        .woocommerce table.shop_table_responsive thead, .woocommerce-page table.shop_table_responsive thead {
            display: none
        }
      
        .woocommerce table.shop_table_responsive tbody tr:first-child td:first-child, .woocommerce-page table.shop_table_responsive tbody tr:first-child td:first-child {
            border-top: 0
        }
      
        .woocommerce table.shop_table_responsive tbody th, .woocommerce-page table.shop_table_responsive tbody th {
            display: none
        }
      
        .woocommerce table.shop_table_responsive tr, .woocommerce-page table.shop_table_responsive tr {
            display: block
        }
      
        .woocommerce table.shop_table_responsive tr td, .woocommerce-page table.shop_table_responsive tr td {
            display: block;
            text-align: right !important
        }
      
        .woocommerce table.shop_table_responsive tr td.order-actions, .woocommerce-page table.shop_table_responsive tr td.order-actions {
            text-align: left !important
        }
      
        .woocommerce table.shop_table_responsive tr td::before, .woocommerce-page table.shop_table_responsive tr td::before {
            content: attr(data-title) ": ";
            font-weight: 700;
            float: left
        }
      
        .woocommerce table.shop_table_responsive tr td.actions::before, .woocommerce table.shop_table_responsive tr td.product-remove::before, .woocommerce-page table.shop_table_responsive tr td.actions::before, .woocommerce-page table.shop_table_responsive tr td.product-remove::before {
            display: none
        }
      
        .woocommerce table.shop_table_responsive tr:nth-child(2n) td, .woocommerce-page table.shop_table_responsive tr:nth-child(2n) td {
            background-color: rgba(0, 0, 0, .025)
        }
      
        .woocommerce table.my_account_orders tr td.order-actions, .woocommerce-page table.my_account_orders tr td.order-actions {
            text-align: left
        }
      
        .woocommerce table.my_account_orders tr td.order-actions::before, .woocommerce-page table.my_account_orders tr td.order-actions::before {
            display: none
        }
      
        .woocommerce table.my_account_orders tr td.order-actions .button, .woocommerce-page table.my_account_orders tr td.order-actions .button {
            float: none;
            margin: .125em .25em .125em 0
        }
      
        .woocommerce .col2-set .col-1, .woocommerce .col2-set .col-2, .woocommerce-page .col2-set .col-1, .woocommerce-page .col2-set .col-2 {
            float: none;
            width: 100%
        }
      
      
        .woocommerce #content div.product div.images, .woocommerce #content div.product div.summary, .woocommerce div.product div.images, .woocommerce div.product div.summary, .woocommerce-page #content div.product div.images, .woocommerce-page #content div.product div.summary, .woocommerce-page div.product div.images, .woocommerce-page div.product div.summary {
            float: none;
            width: 100%
        }
      
        .woocommerce #content table.cart .product-thumbnail, .woocommerce table.cart .product-thumbnail, .woocommerce-page #content table.cart .product-thumbnail, .woocommerce-page table.cart .product-thumbnail {
            display: none
        }
      
        .woocommerce #content table.cart td.actions, .woocommerce table.cart td.actions, .woocommerce-page #content table.cart td.actions, .woocommerce-page table.cart td.actions {
            text-align: left
        }
      
        .woocommerce #content table.cart td.actions .coupon, .woocommerce table.cart td.actions .coupon, .woocommerce-page #content table.cart td.actions .coupon, .woocommerce-page table.cart td.actions .coupon {
            float: none;
            padding-bottom: .5em
        }
      
        .woocommerce #content table.cart td.actions .coupon::after, .woocommerce #content table.cart td.actions .coupon::before, .woocommerce table.cart td.actions .coupon::after, .woocommerce table.cart td.actions .coupon::before, .woocommerce-page #content table.cart td.actions .coupon::after, .woocommerce-page #content table.cart td.actions .coupon::before, .woocommerce-page table.cart td.actions .coupon::after, .woocommerce-page table.cart td.actions .coupon::before {
            content: ' ';
            display: table
        }
      
        .woocommerce #content table.cart td.actions .coupon::after, .woocommerce table.cart td.actions .coupon::after, .woocommerce-page #content table.cart td.actions .coupon::after, .woocommerce-page table.cart td.actions .coupon::after {
            clear: both
        }
      
        .woocommerce #content table.cart td.actions .coupon .button, .woocommerce #content table.cart td.actions .coupon .input-text, .woocommerce #content table.cart td.actions .coupon input, .woocommerce table.cart td.actions .coupon .button, .woocommerce table.cart td.actions .coupon .input-text, .woocommerce table.cart td.actions .coupon input, .woocommerce-page #content table.cart td.actions .coupon .button, .woocommerce-page #content table.cart td.actions .coupon .input-text, .woocommerce-page #content table.cart td.actions .coupon input, .woocommerce-page table.cart td.actions .coupon .button, .woocommerce-page table.cart td.actions .coupon .input-text, .woocommerce-page table.cart td.actions .coupon input {
            width: 48%;
            box-sizing: border-box
        }
      
        .woocommerce #content table.cart td.actions .coupon .button.alt, .woocommerce #content table.cart td.actions .coupon .input-text + .button, .woocommerce table.cart td.actions .coupon .button.alt, .woocommerce table.cart td.actions .coupon .input-text + .button, .woocommerce-page #content table.cart td.actions .coupon .button.alt, .woocommerce-page #content table.cart td.actions .coupon .input-text + .button, .woocommerce-page table.cart td.actions .coupon .button.alt, .woocommerce-page table.cart td.actions .coupon .input-text + .button {
            float: right
        }
      
        .woocommerce #content table.cart td.actions .button, .woocommerce table.cart td.actions .button, .woocommerce-page #content table.cart td.actions .button, .woocommerce-page table.cart td.actions .button {
            display: block;
            width: 100%
        }
      
      
      }
</style>

<script>
    (function ($) {

        const isAUTH = '{{request.user.is_authenticated}}' === 'True' ? true : false;

        $.CartPageManager = function (options) {

            var that = this;

            var keyName = '__nyc_cart__data__';

            var settings = $.extend({}, options);

            var drawCartData = function () {

                var memoryData = getMemoryData();

                var count = 0;
                var totalPrice = parseFloat('0.00');

                $("#itemsList tbody").empty();

                if (!('_ps_' in memoryData)) {
                    count = 0;
                } else {

                    count = memoryData['_ps_'].length;

                    $(memoryData['_ps_']).each(function (ix, item) {

                        var price = item.fields.discounted_price > 0 ? item.fields.discounted_price : item.fields.price;
                        price = parseFloat(price);

                        totalPrice = totalPrice + price;

                        item.final_price = price.toFixed(2);

                        if (!item.fields.image) {
                            item.fields.image = '/static/edutim/images/courses/course-' + (
                                Math.floor(Math.random() * 12) + 1
                            ) + ".jpg";
                        }

                        item.course_link = '/course/' + item.fields.slug;

                        if (!item.fields.slug || item.fields.slug === "") {
                            item.course_link = "#";
                        }

                        var source = document.getElementById("cartItemTemplate").innerHTML;
                        var template = Handlebars.compile(source);

                        $("#itemsList tbody").append(template(item));

                    });

                };

                totalPrice = totalPrice.toFixed(2);

                $(".sub-total-price").html(totalPrice);
                $(".total-price").html(totalPrice);

                var countText = count <= 0 || count > 1 ? " items " : " item";

                $(".top-cart-count").html(count + countText);

                if (count > 0) {
                    $(".wc-proceed-to-checkout").removeClass('d-none');
                }
                else {
                    $(".wc-proceed-to-checkout").addClass('d-none');
                }

                if (isAUTH) {
                    validateCourseEnrolled();
                }

                setGtag_view_cart(memoryData['_ps_'], parseFloat(totalPrice));
            };

            var removeCartItem = function (id) {

                var memoryData = getMemoryData();

                if (('_ps_' in memoryData)) {

                    var dataList = memoryData['_ps_'];

                    var itemIndex = dataList.findIndex(a => a.pk == id);

                    if (itemIndex >= 0) {

                        dataList.splice(itemIndex, 1);

                        memoryData['_ps_'] = dataList;
                        localStorage.setItem(keyName, JSON.stringify(memoryData));

                        drawCartData();

                        console.log('cart updated.');

                        Toast.fire({ icon: 'success', title: 'Course has been removed from cart.' });
                    }
                }

            };

            var getMemoryData = function () {

                try {

                    var memoryData = localStorage.getItem(keyName);

                    var parsedMemoryData = {};

                    if (memoryData) {
                        parsedMemoryData = JSON.parse(memoryData);
                    }

                    return parsedMemoryData;

                } catch (error) {
                    return {};
                }

            };

            var loadMessage = function () {

                var urlParts = window.location.href.split('?');

                if (urlParts.length > 1 && urlParts[1] == 'register=success') {
                    Swal.fire('Account Created!', 'You have successfully created a new account.', 'success');

                    window.location.href = '#';
                }
            };

            var validateCourseEnrolled = function () {

                ShowLoadingModal("Please wait", "Validating Courses..")

                var url = '{% url "api_v1:enrollments-my-list" %}';

                $.get(url, {}, function (response) {

                    $(".cart_item").each(function () {
                        var id = $(this).attr('data-id');
                        var courseName = $(this).find('.product-name').text();

                        if (id && id > 0) {
                            var enrolled = response.find(a => a.course_id == id);
                            if (enrolled) {

                                removeCartItem(id);

                                var dv = $("<div />", { class: 'alert alert-warning mt-3' });
                                dv.html('You are already enrolled in this course: ' + courseName)
                                $("#post-6").append(dv)
                            }
                        }
                    });



                    Swal.close();
                })

            };

            var setGtag_view_cart = function (cartItems, total) {
                try {
                    const items = [];

                    cartItems.forEach(product => {

                        const fields = product.fields;

                        const discounted_price = fields.discounted_price;
                        const price = parseFloat(fields.price);
                        const discounted_price_value = discounted_price ? parseFloat(discounted_price) : 0.00;

                        const itemObject = {
                            item_id: product.pk,
                            item_name: fields.title,
                            affiliation: product.subject,
                            discount: discounted_price_value > 0 ? (price - discounted_price).toFixed(2) : discounted_price_value,
                            index: 0,
                            item_brand: product.subject,
                            item_list_id: product.subject,
                            item_list_name: product.subject_slug,
                            item_variant: 'Premium_Course',
                            location_id: "ChIJEWeHU0PywokRO83ywHyX8q8",
                            price: discounted_price_value > 0 ? discounted_price_value : price,
                            quantity: 1
                        };

                        itemObject.discount = parseFloat(itemObject.discount);

                        items.push(itemObject);
                    });

                    const eventObject = {
                        currency: "USD",
                        value: total,
                        items: items
                    };

                    gtag("event", "view_cart", eventObject);

                    console.log(eventObject)

                } catch (error) {
                    console.log('setGtag_view_cart', error);
                }
            };

            var registerEvent = function () {

                $("div").on("click", '.link-remove-item', function (e) {
                    e.stopPropagation();
                    var id = $(this).attr('data-id');

                    removeCartItem(id);
                });

                $("div").on("click", '.link-auth', function (e) {
                    e.stopPropagation();

                    var opts = {
                        title: 'You need to login as verified user to proceed. ',
                        showDenyButton: true,
                        confirmButtonText: 'Log in',
                        denyButtonText: 'Create a new account'
                    };

                    Swal.fire(opts).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = "{% url 'login' %}?next=" + "{{ request.path }}";
                        } else if (result.isDenied) {
                            window.location.href = "{% url 'student_registration' %}?next=" + "{{ request.path }}";
                        }
                    });



                });


            };

            var init = function () {
                registerEvent();
                drawCartData();
                loadMessage();
            };

            init();

            return this;

        };


    }(jQuery));

    $(document).ready(function () {
        var cartManager = new $.CartPageManager({});
    });
</script>
{% endblock %}