{% extends "student_base.html" %}
{% load i18n %}
{% block title %}
{{ object.title }}
{% endblock %}

{% block nav %}

<nav class="navbar navbar-expand-md navbar-bark bg-dark" id="secNav">

    <button type="button" class="btn btn-warning btn-show mr-2">
        <i class="fa fa-lg fa-long-arrow-right text-white"></i>
    </button>

    <a class="navbar-brand mb-0 h1 text-white" href="#"> {{ object.title }}</a>

    <div class="navbar-collapse">

        <div class="m-auto">
            <div class="digits">
                <h3 class="time-output" id="hours">00</h3>
                <h3 class="colon" id="colon-one">:</h3>
                <h3 class="time-output" id="minutes">00</h3>
                <h3 class="colon" id="colon-two">:</h3>
                <h3 class="time-output" id="seconds">00</h3>
                <h3 class="time-end" id="end">
                </h3>
            </div>
        </div>

        <ul class="navbar-nav ml-auto">

            <li class="nav-item top-audio-1 d-none">
            </li>

            {% if module != None %}

            {% comment %} {% if next_content != None and active_content.complete == True %} {% endcomment %}

            {% if next_content != None %}

            {% if next_content.type == 'quiz' %}

            <li class="nav-item {% if active_content.complete != True %} d-none {% endif %} next-item-link">
                <a href="{% url 'student_course_detail_module' object.id next_content.module.id %}?content={{next_content.object.id}}&type=quiz"
                    class="nav-link text-white btn btn-sm btn-success">Next Chapter (Quiz) >> </a>
            </li>

            {% elif next_content.type == 'content' %}

            <li class="nav-item {% if active_content.complete != True %} d-none {% endif %} next-item-link">
                <a href="{% url 'student_course_detail_module' object.id next_content.module.id %}?content={{next_content.object.id}}"
                    class="nav-link text-white btn btn-sm btn-success">Next Chapter >> </a>
            </li>

            {% endif %}

            {% endif %}
            {% endif %}

            <li class="nav-item dropdown ml-3">
                <a class="nav-link dropdown-toggle text-white btn btn-sm btn-info" data-toggle="dropdown" href="#">
                    Connect Live
                </a>
                <div class="dropdown-menu dropdown-menu-right p-2 rooms">

                    <ul class="list-group" id="live-rooms">
                    </ul>

                </div>
            </li>

            <li class="nav-item dropdown ml-3">
                <a class="nav-link dropdown-toggle text-white" data-toggle="dropdown" href="#">
                    <i class="fa fa-lg fa-cog text-white"></i> {{request.user}}
                </a>
                <div class="dropdown-menu dropdown-menu-right ">
                    <a class="dropdown-item" href="{%url 'student_course_list'%}">Dashboard</a>
                    {% if request.user.is_authenticated %}
                    <a class="dropdown-item" href="{% url "logout" %}">Sign out</a>
                    {%endif%}
                </div>
            </li>
        </ul>

    </div>

</nav>

{% endblock %}

{% block content %}


<div class="container-fluid py-0 px-0" id="fixContainer">
    <!-- <h1 class="header">
        {{ object.title }}
    </h1> -->


    <nav id="sidebar" class="sidebar-wrapper shadow">

        <button type="button" class="btn btn-info btn-sm btn-hide">
            <i class="fa fa-lg fa-long-arrow-left"></i>
        </button>
        <div class="scrollbar-inner">
            <div class="sidebar-content">
                <div class="sidebar-brand">

                    <div class="d-flex justify-content-center">
                        <div class="w-50"> <a href="{% url "student_course_detail" object.id %}"> Course
                                Materials
                            </a></div>
                        <div class="w-50 p-1">

                            <div class="progress position-relative">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 0%"
                                    aria-valuemin="0" aria-valuemax="100"></div>
                                <small style="top:47%" class="justify-content-center d-flex position-absolute w-100">0%
                                    complete</small>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- sidebar-search  -->
                <div class="sidebar-menu">
                    <ul>

                        {% for m in object.modules.all %}

                        <li data-id="{{ m.id }}" class="sidebar-dropdown">

                            <a href="javascript:;" class="{% if m == module %} active {% endif %}">
                                {{ m.title }}
                            </a>

                            <div class="sidebar-submenu">
                                <ul>
                                    {% for content in m.contents.all %}
                                    {% with item=content.item %}

                                    <li class="content-item" data-progress="{{ content.has_progress }}">
                                        {% if content.id in completed_contents or active_content.object.id  == content.id %}

                                        <a class="content-{{content.id}} {% if content.id in completed_contents %}complete{% endif %} {% if active_content.object.id  == content.id %}pin{% endif %}"
                                            href="{% url 'student_course_detail_module' object.id m.id %}?content={{content.id}}">

                                            <i title=" {{ content.content_type }}"
                                                class="fa {{ content.content_type }}"></i>
                                            {{ item.title }}

                                        </a>

                                        {% else %}
                                        <a href="javascript:;">
                                            <i title=" {{ content.content_type }}"
                                                class="fa {{ content.content_type }}"></i>
                                            {{ item.title }}
                                        </a>
                                        {% endif %}

                                    </li>

                                    {% endwith %}
                                    {% endfor %}

                                    {% if m.quiz != None and m.quiz_id in taken_quizzes and m.quiz.questions.count > 0  %}

                                    <li class="content-item" data-progress="True">
                                        <a class="complete"
                                            href="{% url 'student_course_detail_module' object.id m.id %}?content={{m.quiz_id}}&type=quiz">
                                            <i class="fa fa-question-circle-o"></i>
                                            Quiz </a>
                                    </li>

                                    {% elif m.quiz != None and m.quiz.questions.count > 0 %}
                                    <li class="content-item" data-progress="True">
                                        <a href="javascript:;">
                                            <i title="Quiz" class="fa fa-question-circle-o"></i>
                                            Quiz
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </li>

                        {% empty %}
                        <li class="menu__item">No modules yet.</li>

                        {% endfor %}

                    </ul>
                </div>
                <!-- sidebar-menu  -->

                {% if content_completed == True and object.quiz is not None %}

                <div class="sidebar-brand">

                    <a href="{% url "student_course_detail" object.id %}?type=quiz" class="btn btn-dark">
                        Take Quiz </a>
                </div>

                {% endif %}


            </div>
            <!-- sidebar-content  -->
        </div>
    </nav>

    <div class="row">

        <div class="col offset-md-3 mt-2">

            <main class="page-content shadow">

                <div class="row">

                    <div class="col">

                        <button class="btn btn-danger" id="btnMarkAttendance" type="button">
                            <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                            Mark Your Attendance
                        </button>

                        {% if module == None %}

                        {% if request.GET.type == 'quiz' and object.quiz is not None %}
                        <div class="col-md-12 mb-30">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Quiz</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <tr>
                                        <td>
                                            {{active_content.object}}
                                        </td>
                                        <td>
                                            {% if active_content.complete == True %}
                                            {{active_content.score}}
                                            {% else %}
                                            Not Taken
                                            {% endif %}
                                        </td>
                                    </tr>

                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2">
                                            {% if active_content.complete == True %}
                                            <a href="{% url 'quiz_reset' active_content.object.id %}?ref={{request.get_full_path}}"
                                                class="btn btn-primary">Retake Quiz </a>
                                            {% else %}
                                            <a href="{% url 'take_quiz' active_content.object.id %}?ref={{request.get_full_path}}"
                                                class="btn btn-primary">Take Quiz </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="col-md-12">
                            <div class="about-course">

                                {{object.overview|safe}}

                            </div>
                        </div>
                        {%endif%}

                        {%endif%}

                        {% comment %} if module == None {% endcomment %}

                        {% if module != None %}

                        {% if next_content != None and active_content.complete == True %}

                        {% if next_content.type == 'quiz' %}

                        <div class="col-md-12 mb-5 d-none">
                            <a href="{% url 'student_course_detail_module' object.id next_content.module.id %}?content={{next_content.object.id}}&type=quiz"
                                class="btn btn-primary">Next Chapter (Quiz) >> </a>
                        </div>

                        {% elif next_content.type == 'content' %}

                        <div class="col-md-12 mb-5 d-none">
                            <a href="{% url 'student_course_detail_module' object.id next_content.module.id %}?content={{next_content.object.id}}"
                                class="btn btn-primary">Next Chapter >> </a>
                        </div>

                        {% endif %}

                        {% endif %}

                        <!--  if next_content != None -->

                        {% for content in module.contents.all %}

                        {% if active_content.object.id  == content.id and active_content.type == 'content' %}

                        <div class="col-md-12">
                            <div class="about-course">

                                {% with item=content.item %}

                                {% comment %} <h4>{{ item.title }}</h4> {% endcomment %}

                                <div id="contentSection" data-id="{{content.id}}" data-type="{{content.content_type}}"
                                    data-completed="{{active_content.complete}}">
                                    {{ item.render }}
                                </div>

                                {% endwith %}

                            </div>
                        </div>

                        {% endif %}

                        {% endfor %}

                        {% if active_content.type == 'quiz' %}
                        <div class=" col-md-12">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Quiz</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <tr>
                                        <td>
                                            {{active_content.object}}
                                        </td>
                                        <td>
                                            {% if active_content.complete == True %}
                                            {{active_content.score}}
                                            {% else %}
                                            Not Taken
                                            {% endif %}
                                        </td>
                                    </tr>

                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2">
                                            {% if active_content.complete == True %}
                                            <a href="{% url 'quiz_reset' active_content.object.id %}?ref={{request.get_full_path}}"
                                                class="btn btn-primary">Retake Quiz </a>
                                            {% else %}
                                            <a href="{% url 'take_quiz' active_content.object.id %}?ref={{request.get_full_path}}"
                                                class="btn btn-primary">Take Quiz </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {%endif%}

                        {%endif%}

                    </div>

                </div>

            </main>

        </div>
    </div>

</div>

<div id="attendanceModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Mark Today Attendance
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">

                    <div class="col">
                        <video id="picVideo">Video stream not available.</video>
                        <div class="">
                            <button class="btn btn-info btn-sm" id="btnTakePicture">Take Photo</button></div>
                    </div>

                    <div class="col">

                        <canvas id="picCanvas"></canvas>

                        <div class="pic-output text-center">
                            Please take your photo.
                        </div>
                        <div class="">
                            <button class="btn btn-warning mt-1 btn-sm" id="btnClearPhoto">Clear Photo</button></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="btnSaveAttendance">
                    Mark Attendance
                </button>
            </div>

        </div>
    </div>
</div>


{% verbatim %}
<script type="text/x-handlebars-template" id='roomListItemTemplate'>
    <li class="list-group-item d-flex justify-content-between align-items-center">
        {{title}} (INTERNAL)
        <a href="/communicate/video-rooms/{{id}}?ref_course={{ref_course}}" target="_blank" class="link-add-member badge badge-primary badge-pill text-white">Connect</a></li>
    </script>
{% endverbatim %}

{% verbatim %}
<script type="text/x-handlebars-template" id='externalMeetItemTemplate'>
    <li class="list-group-item d-flex justify-content-between align-items-center">
            {{title}} (EXTERNAL)
            <a href="{{url}}" target="_blank" class="link-add-member badge badge-primary badge-pill text-white">Connect</a></li>
    </script>
{% endverbatim %}

{% endblock %}

{% block scripts %}

<link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />

<style>
    .digits {
        display: flex;
        flex-direction: row;
    }


    .digits h3 {
        color: #fff;
    }

    .sidebar-wrapper {
        border-radius: 0;
        min-width: auto;
        position: fixed !important;
        width: 345px;
        left: 1px;
        top: 51px;
        background: #fff;
        border: 1px solid #dddddd;
        border-radius: 2px;
        border-bottom: 3px solid #438aad;
        transition: all 200ms ease 0s;
    }

    .sidebar-wrapper .sidebar-brand {
        margin-bottom: 2px;
        border-radius: 0px;
        background: #0f8aad;
        border: 1px solid #1e7dac;
    }

    .sidebar-wrapper .sidebar-brand a {
        color: #fff;
    }

    .sidebar-wrapper .sidebar-brand a:hover {
        color: #fff;
        background: none;
    }

    .sidebar-content {
        max-height: 100%;
        height: 100%;
    }

    .scrollbar-inner {
        height: 100%;
        max-height: 100%;
    }

    .sidebar-wrapper .sidebar-menu {
        padding: 5px;
        padding-right: 10px;
    }

    .sidebar-wrapper .sidebar-submenu li {
        padding-left: 5px !important;
    }

    .sidebar-wrapper .sidebar-menu ul li a {
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 10%), 0 1px 2px 0 rgb(0 0 0 / 6%);
        border-radius: 6px;
        background: rgb(13 110 253 / .12);
        color: #008cff;
        margin-bottom: 6px;
    }

    .sidebar-wrapper .sidebar-menu ul li.active {
        background: #fff;
    }

    .sidebar-wrapper .sidebar-menu ul li a.active {
        background: #e2edff;
    }

    .sidebar-wrapper .sidebar-menu ul li.active>a {
        color: #fff;
        background: #747474;
    }

    .sidebar-wrapper .sidebar-menu ul li a:hover {
        background: #747474;
        color: #fff;
    }

    .sidebar-wrapper .sidebar-menu .sidebar-submenu a {
        background: #fff;
        color: #000;
        box-shadow: none;
        border: 0;
        border-radius: 0;
    }

    .sidebar-wrapper .sidebar-menu .sidebar-submenu a:hover {
        background: #fff;
        color: #008cff;
    }

    .sidebar-wrapper .sidebar-menu ul li a i {
        float: left;
        margin-right: 7px !important;
        background: #fff;
        border: none;
        color: #000;
    }

    .sidebar-wrapper .sidebar-menu ul li a.pin i {
        background: #e7e7e7;
        color: #000;
    }

    .sidebar-wrapper .sidebar-menu ul li a.complete {
        border-bottom: 1px solid #f3f3f3;
    }

    .sidebar-wrapper .sidebar-menu ul li a.pin {
        background: #e7e7e7;
        color: #353434
    }

    .scrollbar-inner>.scroll-element.scroll-y {
        right: -3px;
    }

    .dropdown-menu.rooms {
        min-width: 25rem;
    }

    .btn-hide {
        position: absolute;
        right: -37px;
        bottom: 0px;
        z-index: 9999;
        border-radius: 0;
    }

    .btn-show {
        border-radius: 0;
        z-index: 9;
    }

    .sidebar-wrapper .sidebar-menu ul li a i.frame:before {
        content: "\f2dc";
    }

    #picVideo {
        border: 1px solid #acacac;
        width: 360px;
        height: 270px;
    }

    #picCanvas {
        display: none;
    }

    .pic-output {
        width: 360px;
        display: inline-block;
        height: 270px;
        border: 1px solid #acacac;
    }


    .pic-out img {
        width: 100%;
        height: 270px;
    }

    #btnMarkAttendance {
        position: absolute;
        right: 20px;
        z-index: 999;
        top: -6px;
    }
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js"
    integrity="sha512-4ze/a9/4jqu+tX9dfOqJYSvyYd5M6qum/3HpCLr+/Jqf0whc37VUbkpNGHR7/8pSnCFw47T1fmIpwBV7UySh3g=="
    crossorigin="anonymous"></script>

<script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>

<script>
    var totalSeconds = 0;
    var lastSavedTime = 0;

    var videoManagerInstance;

    $("#top-nav").hide();

    $('iframe').on("load", function () {
        addAudioTop();
    });

    $(document).ready(function () {

        $("#fixContainer").css({
            'max-height': $(window).height() - $("#secNav").height() - 20,
            'height': $(window).height() - $("#secNav").height() - 20
        });

        $("#sidebar").css({
            'max-height': '90%',
            'height': '90%'
        });

        $(".page-content").css({
            'max-height': $(window).height() - $("#secNav").height() - 30,
            'height': $(window).height() - $("#secNav").height() - 30,
            'overflow': 'hidden',
            'padding': 10
        });

        $("#contentSection").css({
            'max-height': $(window).height() - $("#secNav").height() - 60,
            'height': $(window).height() - $("#secNav").height() - 60,

        });


        $(".sidebar-dropdown > a").click(function () {

            $(".sidebar-submenu").slideUp(200);

            if ($(this).parent().hasClass("active")) {
                $(".sidebar-dropdown").removeClass("active");
                $(this).parent().removeClass("active");
            } else {
                $(".sidebar-dropdown").removeClass("active");
                $(this).next(".sidebar-submenu").slideDown(200);
                $(this).parent().addClass("active");
            }

        });

        $(".btn-hide").click(function () {

            $("#sidebar").hide();

            $(".page-content").parent().removeClass('offset-md-3');
        });

        $(".btn-show").click(function () {

            $("#sidebar").show();
            $(".page-content").parent().addClass('offset-md-3');
        });


        $(".sidebar-dropdown > a.active").trigger('click');

        //videoPlayersState(true);

        setInterval(function () {
            // videoPlayersState(false);
        }, 4000);

        embedFile();

        getTimeLog();

        videoManagerInstance = new $.VideoManager({});

        var liveMeetManager = new $.LiveVideoMeetManager({});

        var attendanceManager = new $.AttendanceManager({});

        checkCourseProgress();

        calculateProgressPercentage();

        jQuery('.scrollbar-inner').scrollbar();

    });

    function videoPlayersState(isSet) {

        var count = document.querySelectorAll('.module_video').length;

        for (let index = 0; index < count; index++) {

            var element = document.querySelectorAll('.module_video')[index];

            if (isSet) {
                setVideoState(element);
            } else {
                saveVideoState(element);
            }

        }
    };

    function setVideoState(element) {

        var storedData = localStorage.getItem("userVideos");

        var d = {
            id: element.id,
            module: element.getAttribute('module_id'),
            watched: element.currentTime,
            created: new Date()
        };

        if (storedData) {

            var parsedData = JSON.parse(storedData);

            for (let index = 0; index < parsedData.length; index++) {

                var parsed = parsedData[index];

                if (parsed.id == d.id && parsed.module == d.module) {
                    element.currentTime = Math.floor(parsed.watched);
                }
            }
        }


    };

    function saveVideoState(element) {

        var storedData = localStorage.getItem("userVideos");

        var d = {
            id: element.id,
            module: element.getAttribute('module_id'),
            watched: element.currentTime,
            created: new Date()
        };

        var parsedData = [];

        if (storedData) {

            parsedData = JSON.parse(storedData);

            var isFound = false;

            // will check & update if found
            for (let index = 0; index < parsedData.length; index++) {
                var parsed = parsedData[index];

                if (parsed.id == d.id && parsed.module == d.module) {
                    parsedData[index] = d;
                    isFound = true;
                }
            }

            // will add the new 
            if (!isFound) {
                parsedData.push(d);
            }
        } else {
            parsedData.push(d);
        }

        localStorage.setItem("userVideos", JSON.stringify(parsedData));
    };

    function embedFile() {

        if ($(".file-item").length > 0) {

            var href = $(".file-item").eq(0).attr('href');

            if (href) {

                if (href.toLowerCase().indexOf(".png") >= 0) {

                    var img = $("<img />", {
                        src: href
                    });

                    $(".file-item").eq(0).replaceWith(img);

                } else if (href.toLowerCase().indexOf(".pdf") >= 0) {

                    var pdfDiv = $("<div />", {
                        id: 'pdfViewer'
                    });

                    pdfDiv.css({
                        width: '100%',
                        'min-height': 600
                    });

                    $(".file-item").eq(0).replaceWith(pdfDiv);

                    var options = {
                        height: "580px",
                        width: '100%',
                        pdfOpenParams: {
                            view: 'FitV',
                            page: '1'
                        }
                    };

                    PDFObject.embed(href, "#pdfViewer", options);
                }
            }
        }

    };

    function addAudioTop() {

        if ($(".about-course iframe").length > 0) {

            if ($(".about-course iframe").eq(0).contents().find('audio:eq(0) source').length > 0) {

                var src = $(".about-course iframe").eq(0).contents().find('audio:eq(0) source')[0].src;

                if (src) {

                    var ad = '<audio id="audio-player" controls="controls" src="' + src + '" type="audio/mpeg">';

                    $(".top-audio-1").html(ad);
                    $(".top-audio-1").removeClass('d-none');
                    $(".about-course iframe").eq(0).contents().find('audio:eq(0)').hide();

                    $(".top-audio-1 audio").css({
                        'height': 33,
                        'margin-right': 20,
                        'margin-top': 5
                    })
                }

            }
        }

    }

    function getTimeLog() {

        $.get('/api/courses_time_logs/', {
            course: '{{object.id}}'
        }, function (response) {

            if (response && response.length > 0) {
                totalSeconds = response[response.length - 1].total_seconds;
            }

            timeCounter();

        });
    };

    var saveTimeLog = function () {

        var data = {
            course: '{{object.id}}',
            total_seconds: totalSeconds
        };

        $.ajax({
            type: "POST",
            url: "/api/courses_time_logs/",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success: function (response) {
                console.log(response)
            },
            failure: function (errMsg) {}
        });
    };

    function timeCounter() {
        setInterval(() => {

            totalSeconds += 1;

            lastSavedTime++;

            if (lastSavedTime >= 55) {
                saveTimeLog();
                lastSavedTime = 0;
            }

            secondsToHms(totalSeconds);

        }, 1000);
    };

    function pad(str, max) {
        str = str.toString();
        return str.length < max ? pad("0" + str, max) : str;
    };

    function secondsToHms(d) {

        d = Number(d);
        var h = Math.floor(d / 3600);
        var m = Math.floor(d % 3600 / 60);
        var s = Math.floor(d % 3600 % 60);

        $("#hours").html(pad(h, 2));
        $("#minutes").html(pad(m, 2));
        $("#seconds").html(pad(s, 2));

    };

    var checkCourseProgress = function () {

        if ($("#contentSection").length > 0) {

            var id = $("#contentSection").attr('data-id');
            var content_type = $("#contentSection").attr('data-type');
            var is_completed = $("#contentSection").attr('data-completed');

            if (is_completed != 'False') {
                return;
            }

            var data = {
                content: id,
                is_completed: true,
                content_type: content_type
            };

            if (content_type != 'video' || $("#videoFrame").length > 0) {
                saveCourseProgress(data);
            } else if (content_type == 'video' && $("#myVideo[completed='true']").length > 0) {
                saveCourseProgress(data);
            }

        }

    };

    var saveCourseProgress = function (data) {

        $.ajax({
            type: "POST",
            url: "/api/course_progress/",
            data: data,
            //contentType: "application/json; charset=utf-8",
            //dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success: function (response) {
                if (response.id > 0) {
                    $(".next-item-link").removeClass('d-none');
                    $(".content-" + data.content).addClass('complete');
                }
            },
            failure: function (errMsg) {}
        });

    };

    var calculateProgressPercentage = function () {

        var total = $(".content-item[data-progress='True']").length;
        var completeTotal = $(".content-item[data-progress='True'] .complete").length;

        var per = (completeTotal / total) * 100;

        per = Math.ceil(per);

        $(".progress-bar").css('width', per + '%');

        $(".progress small").html(per + '% complete');

    };

    (function ($) {

        $.VideoManager = function (options) {

            var that = this;
            var player;

            var settings = $.extend({}, options);

            var gcd = function (a, b) {
                return (b == 0) ? a : gcd(b, a % b);
            };

            var registerEvent = function () {

                if ($("#myVideo").length > 0) {

                    var w = $("#contentSection").width();
                    var h = $("#contentSection").height();

                    var r = gcd(w, h);

                    player = videojs('myVideo', {
                        controls: true,
                        autoplay: false,
                        preload: 'auto',
                        //height: $("#contentSection").height(),
                        //width: $("#contentSection").width(),
                        fluid: true,
                        aspectRatio: '945:524'
                    });

                    player.ready(function () {

                        var duration_time = Math.floor(this.duration());

                        this.on("ended", function () {
                            $("#myVideo").attr('completed', 'true');
                            checkCourseProgress();
                        });

                    });

                }
            };

            var init = function () {
                registerEvent();
            };

            init();

            return this;

        };


        $.LiveVideoMeetManager = function (options) {

            var internalMeetList = [];
            var externalMeetList = [];

            var settings = $.extend({}, options);

            var getExternalVideos = function () {

                var data = {
                    course: '{{object.id}}',
                    today: true,
                    delete: false
                };

                $.get('/api/external-video-room/?format=json', data, function (response) {
                    externalMeetList = response;
                    drawExternalURLs();
                });

            };

            var getRooms = function () {
                $.get('/api/video-rooms/?format=json', {}, function (response) {
                    internalMeetList = response;
                    fillRoomsTable();
                });
            };

            var fillRoomsTable = function () {

                $(internalMeetList).each(function (index, item) {

                    var course = item.courses.find(a => a.course.id == '{{object.id}}');

                    if (course) {

                        var source = document.getElementById("roomListItemTemplate").innerHTML;
                        var template = Handlebars.compile(source);

                        item.ref_course = window.location.href.replace(window.location.origin, "");

                        $("#live-rooms").append(template(item));
                    }

                });

                if ($("#live-rooms li").length <= 0) {
                    $("#live-rooms").append(
                        '<li class="list-group-item">No live connection is created yet.</li>');
                }

            };

            var drawExternalURLs = function () {

                $(externalMeetList).each(function (index, item) {

                    var source = document.getElementById("externalMeetItemTemplate").innerHTML;
                    var template = Handlebars.compile(source);

                    $("#live-rooms").append(template(item));

                });

                getRooms();

            };


            var registerEvent = function () {
                $("#live-rooms").empty();
            };

            var init = function () {
                registerEvent();
                getExternalVideos();
            };

            init();

            return this;

        };

        $.AttendanceManager = function (options) {

            var that = this;
            var attendesList = [];

            var streaming = false;

            var width = 360;
            var height = 0;

            var video = document.getElementById('picVideo');
            var canvas = document.getElementById('picCanvas');

            var videoStream;

            var settings = $.extend({}, options);

            var getTodayAttendance = function () {
                $.get('/api/attendance/', {
                    today: true,
                    course: '{{object.id}}',
                    student: '{{ request.user.id }}'
                }, function (response) {
                    attendesList = response;
                    drawTodayAttendance();
                });
            };

            var drawTodayAttendance = function () {

                if (attendesList.length > 0)
                    $("#btnMarkAttendance").remove();
            }

            var startCamera = function () {

                navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: false
                    })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.play();
                        videoStream = stream;
                    })
                    .catch(function (err) {
                        $(".pic-output img").attr('alt', 'Please allow camera to capture the image.')
                    });

                video.addEventListener('canplay', function (ev) {

                    if (!streaming) {
                        height = video.videoHeight / (video.videoWidth / width);

                        if (isNaN(height)) {
                            height = width / (4 / 3);
                        }

                        video.setAttribute('width', width);
                        video.setAttribute('height', height);
                        canvas.setAttribute('width', width);
                        canvas.setAttribute('height', height);
                        streaming = true;
                    }
                }, false);

            };

            var takePicture = function () {

                var context = canvas.getContext('2d');

                if (width && height) {

                    canvas.width = width;
                    canvas.height = height;
                    context.drawImage(video, 0, 0, width, height);

                    var data = canvas.toDataURL('image/png');

                    var img = $("<img />", {
                        src: data,
                        id: 'photo'
                    });

                    $(".pic-output").html(img);


                } else {
                    clearphoto();
                }
            }

            var clearPhoto = function () {

                var context = canvas.getContext('2d');
                context.fillStyle = "#AAA";
                context.fillRect(0, 0, canvas.width, canvas.height);

                var data = canvas.toDataURL('image/png');

                $(".pic-output").html('Please take your photo');

            };


            var saveBaseImage = function () {

                var imgSrc = $(".pic-output img").attr('src');

                if (!imgSrc) {
                    toastr.error('Please provide the image');
                    return;
                }

                var formData = {
                    image_data: imgSrc,
                    course: '{{object.id}}'
                };

                $.ajax({
                    type: "POST",
                    url: "/api/save-base64/",
                    data: JSON.stringify(formData),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken",
                            '{{ csrf_token }}');
                    },
                    success: function (response) {
                        if (response.result) {
                            markAttendance(response.result);
                        } else {
                            toastr.error(
                                'Sorry your request has been failed. Please try again');
                        }
                    },
                    failure: function (errMsg) {}
                });

            };

            var markAttendance = function (imageSrc) {

                var formData = {
                    course: '{{ object.id }}',
                    student: '{{request.user.id}}',
                    event_type: 1,
                    image: imageSrc
                };

                $.ajax({
                    type: "POST",
                    url: "/api/attendance/",
                    data: JSON.stringify(formData),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken",
                            '{{ csrf_token }}');
                    },
                    success: function (response) {
                        toastr.success('Attendance is marked.');
                        $("#btnMarkAttendance").remove();
                        $("#attendanceModal").modal('hide');
                    },
                    failure: function (errMsg) {}
                });

            };

            var registerEvent = function () {

                $("div").on("click", '#btnMarkAttendance', function (e) {
                    e.stopPropagation();
                    $("#attendanceModal").modal('show');
                });

                $("div").on("click", '#btnTakePicture', function (e) {
                    e.stopPropagation();
                    takePicture();

                });

                $("div").on("click", '#btnClearPhoto', function (e) {
                    e.stopPropagation();
                    clearPhoto();
                });

                $("div").on("click", '#btnSaveAttendance', function (e) {
                    e.stopPropagation();
                    saveBaseImage();
                });

                $('#attendanceModal').on('shown.bs.modal', function () {
                    startCamera();
                });

                $('#attendanceModal').on('hidden.bs.modal', function () {
                    try {

                        videoStream.getTracks().forEach((track) => {
                            track.stop();
                        });

                        video.srcObject = null;
                        $(".pic-output").html('Please take your photo');

                    } catch (e) {}
                });


            };

            var init = function () {
                registerEvent();
                getTodayAttendance();
            };

            init();

            return this;

        };


    }(jQuery));
</script>
{% endblock %}