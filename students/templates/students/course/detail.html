{% extends "base.html" %}
{% load i18n %}
{% block title %}
{{ object.title }}
{% endblock %}
{% block content %}

<div class="container-fluid">
    <h1 class="header">
        {{ module.title }}
    </h1>

    <div class="row">
        <div class="col-md-3">
            <nav id="sidebar" class="sidebar-wrapper">
                <div class="sidebar-content">
                    <div class="sidebar-brand">
                        <a href="#"> Modules </a>
                    </div>
                    <!-- sidebar-search  -->
                    <div class="sidebar-menu">
                        <ul>

                            {% for m in object.modules.all %}
                            <li data-id="{{ m.id }}">
                                <a href="{% url 'student_course_detail_module' object.id m.id %}"
                                    class="{% if m == module %} active {% endif %}">
                                    <span> Module <span class="order">{{ m.order|add:1 }} </span>
                                    </span>
                                    <br>
                                    {{ m.title }}
                                </a> </li>
                            {% empty %}
                            <li class="menu__item">No modules yet.</li>

                            {% endfor %}

                        </ul>
                    </div>
                    <!-- sidebar-menu  -->
                </div>
                <!-- sidebar-content  -->
            </nav>
        </div>
        <div class="col-md-9">
            <main class="page-content">
                <div class="clever-description">

                    <div class="row ">
                        {% for content in module.contents.all %}

                        <div class="col-md-12 mb-30">
                            <div class="about-course">
                                {% with item=content.item %}

                                <h4>{{ item.title }}</h4>
                                <div>
                                    {{ item.render }}
                                </div>

                                {% endwith %}
                            </div>
                        </div>

                        {% endfor %}

                        <div class="col-md-12 mb-30">
                            {% if module.quiz_id %}
                            <h3>
                                <a href="{% url 'take_quiz' module.quiz_id %}" style="color: blue;">Take Course Quiz</a>
                            </h3>
                            {% endif %}
                        </div>


                        {% if module.contents.count == 0 %}
                        <div class="col-md-12 mb-30">
                            <h3> No Content Found </h3>
                        </div>
                        {% endif %}


                    </div>

                </div>
            </main>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {

        videoPlayersState(true);

        setInterval(function () {
            videoPlayersState(false);
        }, 4000);

    });

    function videoPlayersState(isSet) {

        var count = document.querySelectorAll('.module_video').length;

        for (let index = 0; index < count; index++) {

            var element = document.querySelectorAll('.module_video')[index];

            if (isSet) {
                setVideoState(element);
            }
            else {
                saveVideoState(element);
            }


            console.log(element.currentTime);
            console.log(element.duration);

        }
    };

    function setVideoState(element) {

        var storedData = localStorage.getItem("userVideos");

        var d = {
            id: element.id,
            module: element.getAttribute('module_id'),
            watched: element.currentTime,
            created: new Date()
        };

        if (storedData) {

            var parsedData = JSON.parse(storedData);

            for (let index = 0; index < parsedData.length; index++) {

                var parsed = parsedData[index];

                if (parsed.id == d.id && parsed.module == d.module) {
                    element.currentTime = Math.floor(parsed.watched);
                }
            }
        }


    };

    function saveVideoState(element) {

        var storedData = localStorage.getItem("userVideos");

        var d = {
            id: element.id,
            module: element.getAttribute('module_id'),
            watched: element.currentTime,
            created: new Date()
        };

        var parsedData = [];

        if (storedData) {

            parsedData = JSON.parse(storedData);

            var isFound = false;

            // will check & update if found
            for (let index = 0; index < parsedData.length; index++) {
                var parsed = parsedData[index];

                if (parsed.id == d.id && parsed.module == d.module) {
                    parsedData[index] = d;
                    isFound = true;
                }
            }

            // will add the new 
            if (!isFound) {
                parsedData.push(d);
            }
        }
        else {
            parsedData.push(d);
        }

        localStorage.setItem("userVideos", JSON.stringify(parsedData));
    };

</script>
{% endblock %}